#!/bin/sh

#
# Copyright (C) 2015 Canonical Ltd
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License version 3 as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Authored by: Michi Henning <michi.henning@canonical.com>
#

# Script to check whether the ABI is still intact.
#
# The base ABI (for version <x>.<y>.0) is kept in libunity-scopes_<x>.<y>.0.abi.xml.gz.
# If the micro version is non-zero, we run abidiff to compare the two versions.
# If there are any complaints, we print an error message ane return non-zero status.

set -x
echo "build type: " "@CMAKE_BUILD_TYPE@"
echo "flags: " "@CMAKE_CXX_FLAGS@"
echo "debug flags: " "@CMAKE_CXX_FLAGS_DEBUG@"
progname=$(basename $0)

distro=$(lsb_release -c -s)
[ "$distro" = "vivid" ] && {
    echo "${progname}: Distribution is ${distro}, skipping ABI compliance check."
    exit 0
}

[ @UNITY_SCOPES_MICRO@ -eq 0 ] && exit 0

libname=lib@UNITY_SCOPES_LIB@
base_abi_dir=@CMAKE_CURRENT_SOURCE_DIR@/abi_dumps/@CMAKE_LIBRARY_ARCHITECTURE@
base_abi=${libname}_@UNITY_SCOPES_MAJOR_MINOR@.0.abi.xml

cp ${base_abi_dir}/${base_abi}.gz .
gunzip -f ${base_abi}.gz

cur_abi=${libname}_@UNITY_SCOPES_FULL_VERSION@.abi.xml
report=${libname}_@UNITY_SCOPES_FULL_VERSION@_abi-report.txt

# Compare against the base ABI.
abidiff ${base_abi} ${cur_abi} >${report} 2>&1
status=$?

[ $status -ge 8 ] && {
    echo "${progname}: ERROR: Incompatible ABI!" >&2
    cat ${report} >&2
}

[ $status -eq 0 ] && rm -f $report

exit $status
